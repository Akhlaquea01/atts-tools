<div class="json-diff-container">
    <!-- Compact Control Bar -->
    <div class="control-bar">
        <div class="bar-left">
            <h2 class="app-title">JSON Diff</h2>

            <div class="view-toggles">
                <button [class.active]="viewMode() === 'split'" (click)="hasResults() && toggleViewMode('split')"
                    [disabled]="!hasResults()" class="icon-toggle" title="Split View">
                    <span>‚ö°</span>
                </button>
                <button [class.active]="viewMode() === 'tree'" (click)="hasResults() && toggleViewMode('tree')"
                    [disabled]="!hasResults()" class="icon-toggle" title="Tree View">
                    <span>üå≥</span>
                </button>
                <button [class.active]="viewMode() === 'raw'" (click)="hasResults() && toggleViewMode('raw')"
                    [disabled]="!hasResults()" class="icon-toggle" title="Raw Diff">
                    <span>üìÑ</span>
                </button>
            </div>

            <div class="search-compact">
                <span class="search-icon">üîç</span>
                <input type="text" [(ngModel)]="searchQuery" (input)="searchInJson()" placeholder="Search..."
                    class="search-input-compact">
                @if (hasSearch()) {
                <div class="search-actions">
                    <span class="count">{{ currentSearchIndex() + 1 }}/{{ searchResults().length }}</span>
                    <button (click)="previousSearchResult()">‚Üë</button>
                    <button (click)="nextSearchResult()">‚Üì</button>
                    <button (click)="clearSearch()">‚úï</button>
                </div>
                }
            </div>
        </div>

        <div class="bar-right">
            <button (click)="loadSample()" class="text-btn">Sample</button>
            <button (click)="clearAll()" class="text-btn">Clear</button>

            <div class="vr"></div>

            @if (!isEditing()) {
            <button (click)="enterEditMode()" class="primary-action-btn">
                <span>‚úèÔ∏è Edit</span>
            </button>
            } @else {
            <button (click)="compareJson()" class="primary-action-btn">
                <span>üîç Compare</span>
            </button>
            }

            <div class="vr"></div>

            <!-- Copy Menu -->
            <div class="dropdown">
                <button class="icon-btn-large" title="Copy Options">
                    <span>üìã</span> <span class="btn-label">Copy</span> ‚ñº
                </button>
                <div class="dropdown-menu right">
                    <button (click)="copyLeft()" class="dropdown-item">Copy Left</button>
                    <button (click)="copyRight()" class="dropdown-item">Copy Right</button>
                    <button (click)="copyDiff()" class="dropdown-item" [disabled]="!hasResults()">Copy Diff</button>
                </div>
            </div>

            <!-- Download Menu -->
            <div class="dropdown">
                <button class="icon-btn-large" title="Download Options">
                    <span>üíæ</span> <span class="btn-label">Save</span> ‚ñº
                </button>
                <div class="dropdown-menu right">
                    <button (click)="downloadLeft()" class="dropdown-item">Download Left</button>
                    <button (click)="downloadRight()" class="dropdown-item">Download Right</button>
                    <button (click)="downloadDiff()" class="dropdown-item" [disabled]="!hasResults()">Save Diff</button>
                    <button (click)="downloadComparison()" class="dropdown-item" [disabled]="!hasResults()">Save
                        Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Feedback (Toast) -->
    @if (copyFeedback()) {
    <div class="copy-feedback">{{ copyFeedback() }}</div>
    }

    <!-- Error Message -->
    @if (error()) {
    <div class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span> {{ error() }}
    </div>
    }

    <!-- Raw Diff Result Section (Shown ONLY when viewMode is 'raw' and has results) -->
    @if (hasResults() && viewMode() === 'raw') {
    <div class="diff-result-section maximized">
        <div class="result-header">
            <h3>Diff Result (JSON Patch Format)</h3>
            <div class="result-actions">
                <button (click)="copyDiff()" class="action-btn">
                    <span class="icon">üìã</span> Copy
                </button>
                <button (click)="downloadDiff()" class="action-btn">
                    <span class="icon">üíæ</span> Download
                </button>
            </div>
        </div>
        <pre class="diff-output"><code>{{ diffResult() }}</code></pre>
    </div>
    } @else {
    <!-- Main Comparison Area (For Split, Tree, and Edit modes) -->
    <div class="comparison-area">
        <!-- Left Editor -->
        <div class="editor-panel" [class.invalid]="!leftValid()">
            <div class="panel-header">
                <div class="panel-title">
                    <h3>Left JSON</h3>
                    <span class="size-badge">{{ leftSize() }}</span>
                    @if (leftValid()) {
                    <span class="valid-badge">‚úì Valid</span>
                    } @else {
                    <span class="invalid-badge">‚úó Invalid</span>
                    }
                </div>
                <div class="panel-actions">
                    <label class="file-upload-btn">
                        <span class="icon">üìÅ</span> Upload
                        <input type="file" accept=".json" (change)="onLeftFileSelect($event)" hidden>
                    </label>
                    <button (click)="formatLeft()" class="icon-btn" title="Format">‚ú®</button>
                    <button (click)="minifyLeft()" class="icon-btn" title="Minify">‚ö°</button>
                </div>
            </div>

            @if (viewMode() === 'tree' && leftTree().length > 0 && hasResults()) {
            <div class="tree-view">
                @for (node of leftTree(); track node.path) {
                <div class="tree-node" [class]="'diff-' + node.diffType">
                    <div class="tree-node-content" (click)="toggleNode(node)">
                        @if (node.children && node.children.length > 0) {
                        <span class="expand-icon">{{ node.expanded ? '‚ñº' : '‚ñ∂' }}</span>
                        }
                        <span class="node-key">{{ node.key }}</span>
                        <span class="node-type">{{ node.type }}</span>
                        @if (node.type !== 'object' && node.type !== 'array') {
                        <span class="node-value">{{ node.value }}</span>
                        }
                    </div>
                    @if (node.expanded && node.children) {
                    <div class="tree-children">
                        @for (child of node.children; track child.path) {
                        <div class="tree-node" [class]="'diff-' + child.diffType">
                            <div class="tree-node-content">
                                <span class="node-key">{{ child.key }}</span>
                                <span class="node-type">{{ child.type }}</span>
                                @if (child.type !== 'object' && child.type !== 'array') {
                                <span class="node-value">{{ child.value }}</span>
                                }
                            </div>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            } @else if (viewMode() === 'split' && hasResults()) {
            <div class="code-diff-view">
                @for (line of leftDiffLines(); track $index) {
                <div class="code-line" [class]="line.type">
                    <span class="line-number">{{ line.lineNum || '' }}</span>
                    <span class="line-content">{{ line.text }}</span>
                </div>
                }
            </div>
            } @else {
            <textarea [(ngModel)]="leftJson" placeholder="Paste or upload JSON here..." class="json-editor"
                [class.error]="!leftValid()" spellcheck="false" rows="20"></textarea>
            }
        </div>

        <!-- Center stats or spacer -->
        @if (hasResults()) {
        <div class="center-gutter">
            <div class="stat-badge added" title="Added">+{{ diffStats().added }}</div>
            <div class="stat-badge removed" title="Removed">-{{ diffStats().removed }}</div>
            <div class="stat-badge modified" title="Modified">~{{ diffStats().modified }}</div>
        </div>
        } @else {
        <div class="center-gutter empty"></div>
        }

        <!-- Right Editor -->
        <div class="editor-panel" [class.invalid]="!rightValid()">
            <div class="panel-header">
                <div class="panel-title">
                    <h3>Right JSON</h3>
                    <span class="size-badge">{{ rightSize() }}</span>
                    @if (rightValid()) {
                    <span class="valid-badge">‚úì Valid</span>
                    } @else {
                    <span class="invalid-badge">‚úó Invalid</span>
                    }
                </div>
                <div class="panel-actions">
                    <label class="file-upload-btn">
                        <span class="icon">üìÅ</span> Upload
                        <input type="file" accept=".json" (change)="onRightFileSelect($event)" hidden>
                    </label>
                    <button (click)="formatRight()" class="icon-btn" title="Format">‚ú®</button>
                    <button (click)="minifyRight()" class="icon-btn" title="Minify">‚ö°</button>
                </div>
            </div>

            @if (viewMode() === 'tree' && rightTree().length > 0 && hasResults()) {
            <div class="tree-view">
                @for (node of rightTree(); track node.path) {
                <div class="tree-node" [class]="'diff-' + node.diffType">
                    <div class="tree-node-content" (click)="toggleNode(node)">
                        @if (node.children && node.children.length > 0) {
                        <span class="expand-icon">{{ node.expanded ? '‚ñº' : '‚ñ∂' }}</span>
                        }
                        <span class="node-key">{{ node.key }}</span>
                        <span class="node-type">{{ node.type }}</span>
                        @if (node.type !== 'object' && node.type !== 'array') {
                        <span class="node-value">{{ node.value }}</span>
                        }
                    </div>
                    @if (node.expanded && node.children) {
                    <div class="tree-children">
                        @for (child of node.children; track child.path) {
                        <div class="tree-node" [class]="'diff-' + child.diffType">
                            <div class="tree-node-content">
                                <span class="node-key">{{ child.key }}</span>
                                <span class="node-type">{{ child.type }}</span>
                                @if (child.type !== 'object' && child.type !== 'array') {
                                <span class="node-value">{{ child.value }}</span>
                                }
                            </div>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            } @else if (viewMode() === 'split' && hasResults()) {
            <div class="code-diff-view">
                @for (line of rightDiffLines(); track $index) {
                <div class="code-line" [class]="line.type">
                    <span class="line-number">{{ line.lineNum || '' }}</span>
                    <span class="line-content">{{ line.text }}</span>
                </div>
                }
            </div>
            } @else {
            <textarea [(ngModel)]="rightJson" placeholder="Paste or upload JSON here..." class="json-editor"
                [class.error]="!rightValid()" spellcheck="false" rows="20"></textarea>
            }
        </div>
    </div>
    }

    <!-- Format Options (collapsible) -->
    <details class="format-options">
        <summary>‚öôÔ∏è Format Options</summary>
        <div class="options-content">
            <label class="option-item">
                <span>Indent Size:</span>
                <input type="number" [(ngModel)]="indentSize" min="0" max="8" class="indent-input">
            </label>
            <label class="option-item checkbox">
                <input type="checkbox" [(ngModel)]="sortKeys">
                <span>Sort Keys Alphabetically</span>
            </label>
            <label class="option-item checkbox">
                <input type="checkbox" [ngModel]="showOnlyDifferences()" (ngModelChange)="toggleOnlyDifferences()">
                <span>Show Only Differences</span>
            </label>
            <label class="option-item checkbox">
                <input type="checkbox" [ngModel]="syncScroll()" (ngModelChange)="toggleSyncScroll()">
                <span>Sync Scroll</span>
            </label>
        </div>
    </details>
</div>
